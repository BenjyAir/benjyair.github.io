<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="我大步走大步跑，我没有追我不会累"/>
    <meta name="keywords" content="android,github,Open Source,kokerwang"/>
    <meta name="author" content="www.kokerwang.com"/> 
    <link rel="canonical" href=""/>
    <!--<link href="http://liyouhai.com/rss.xml" title="RSS 2.0" type="application/rss+xml" rel="alternate"/>-->
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <title>下拉刷新封装 - KokerWang's blog</title>
    <link rel="stylesheet" href="/css/min/pure-min.css"/>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/min/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="/css/min/grids-responsive-min.css"/>
    <!--<![endif]-->

    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/JekyllPure-old-ie.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="/css/JekyllPure.css"/>
    <!--<![endif]-->

    <link href="/css/min/font-awesome.min.css" rel="stylesheet"/>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/min/font-awesome-ie7.min.css">
    <![endif]-->
    <script src="/js/min/jquery-1.7.2.min.js"></script>
</head>

<body>

<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
        <div class="header">
            <div class="headerpic">
                <a href="/">
                    <img src="/img/kokerwang.jpg" alt="Profile Picture" style="width: 140px;" title="KokerWang's blog">
                </a>
            </div>
            <h1 class="brand-title">KokerWang</h1>
            <h2 class="brand-tagline">on the way  don't weary</h2>

            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a class="pure-button" href="/timing">时间轴</a>
                    </li>
                    <li class="nav-item">
                        <a class="pure-button" href="/tag">标签库</a>
                    </li>
                    <li class="nav-item">
                        <a class="pure-button" href="/about">关于我</a>
                    </li>
                </ul>
            </nav>
            <!--<div class="search">
                <form action="/search">
                    <input type="text" class="search-query" placeholder="Search Blog" name="query" title="全站搜索-只支持英文">
                </form>
            </div>-->
            <div id="toc"></div>
            <nav id="nav">
                <ul class="nav-list">
                    <li class="nav-link">
                    <a class="weibo "  href="http://kokerwang.lofter.com/" ><i class="fa fa-weibo fa-2x"></i></a>
                    </li>
                    <li class="nav-link">
                    <a class="github" href="https://github.com/kokerwang"><i class="fa fa-github fa-2x"></i></a>
                    </li>
                    <li class="nav-link">
                    <a class="rss" href="/rss.xml" ><i class="fa fa-rss fa-2x"></i></a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <!--[if lt IE 8]>
        <i class="label label-danger">亲爱的用户，您的浏览器版本过低，建议您升级浏览器获得更好的用户体验</i>
        <![endif]-->
        <div>
            <div class="posts">

                <div class="qrcodeTable"></div>
<header class="post-header">
    <img class="post-avatar" height="48" width="48"
         src="/img/5.jpeg">

    <h2 class="post-title">下拉刷新封装</h2>

    <p class="post-meta">By 10月21日  2014  <a
            class="post-categorybut " href="/type/#">android</a><a
            class="post-category " href="/tag/#开源库"> 开源库</a><a
            class="post-category " href="/tag/#工作总结">  工作总结</a>
    </p>
</header>
<div class="article pure-u-22-24">
    <hr />

<h2>前言</h2>

<p> 忙了两周,楼里app终于完成了,25号正式上线,顺便吐槽一下接私活果然好坑,特别是这种工期比较着急的,不过今天款项下来了,拿到money之后感觉整个人萌萌哒~~ 废话不多说,今天分享一下自己在工作中对<a href="https://github.com/chrisbanes/Android-PullToRefresh">Android-PullToRefresh</a>的封装</p>

<h2>简介</h2>

<p>目前Android上实现下拉刷新的方式主要有两种:</p>

<blockquote><ul>
<li>通过修改HeaderView的Padding实现,常见作法是使用自定义组件继承ListView,一个类就可以搞定</li>
<li>在listview底部套一层ScrollView或者LinearLayout,通过移动ListView来实现</li>
</ul>
</blockquote>

<p>第一种方法简单但是碰到复杂的ListView,特别是带有图片的的item就会特别卡,因为主线程刷新界面也需要时间,而改变之后的效果只有刷新之后才能看到,所以给人的感觉是一顿一顿的.第二种方法就不会出现这样的效果,这里推荐的是Android-PullToRefresh,具体使用大家可以看该项目的demo,该项目对常见的带滑动的组件都有支持,很强大,而且可以定制.</p>

<h2>使用</h2>

<p>我的封装主要是对消息处理的封装和页码计算的封装,使你只用写自己逻辑而不用管这些细节
直接看代码, 首先是封装类</p>

<pre><code class="java">package com.louli.activity.louli;

import java.text.SimpleDateFormat;
import java.util.List;
import android.app.Activity;
import android.os.Message;
import android.widget.BaseAdapter;
import android.widget.ListView;
import android.widget.Toast;

import com.handmark.pulltorefresh.library.PullToRefreshBase;
import com.handmark.pulltorefresh.library.PullToRefreshBase.Mode;
import com.handmark.pulltorefresh.library.PullToRefreshBase.OnRefreshListener2;
import com.handmark.pulltorefresh.library.PullToRefreshListView;
import com.louli.community.R;

/**
 * 带下拉刷新的activity 需要继承该类
 * 
 * @author KokerWang
 * 
 */
public abstract class ListViewBaseActivity extends Activity {

    /**
     * 分页的页码，当前第几页
     */
    public int pageCount = 1;

    /**
     * 当前刷新状态　　-1　下拉　,　1　　上拉 , 0 默认值
     */
    public int status;

    /**
     * 获取页码   如果界面里有1个以上的 PullToRefreshListView组件需要重重写 pageCount的get set 方法,自己记录页码
     * 
     * @return
     */
    public int getPageCount() {
        return pageCount;
    }

    /**
     * 设置页码  如果界面里有1个以上的 PullToRefreshListView组件需要重重写 pageCount的get set 方法,自己记录页码
     * 
     * @param pageCount
     */
    public void setPageCount(int pageCount) {
        this.pageCount = pageCount;
    }

    /**
     * 返回数据内容的集合
     * 
     * @return
     */
    public abstract List&lt;?&gt; getList();

    /**
     * 返回ListView
     * 
     * @return
     */
    public abstract PullToRefreshListView getListView();

    /**
     * 返回适配器
     * 
     * @return
     */
    public abstract BaseAdapter getAdapter();

    /**
     * 该方法主要完成异步获取数据分别需要处理三种结果 获取成功 msg.what=LOAD_SUCCESS 获取失败
     * msg.what=LOAD_FAIL 没有数据 msg.what=LOAD_NODATA 获取成功的数据放在msg.obj 里 ，List 类型
     */
    public abstract void loadData();

    /**
     * 初始化带刷新的ListView
     * 
     * @param id
     *            组件id
     * @return
     */
    protected PullToRefreshListView initListView(int id) {
        PullToRefreshListView listView = (PullToRefreshListView) findViewById(id);
        if (listView == null) {
            return null;
        }
        return initListView(listView);
    }

    /**
     * 初始化带刷新的ListView
     * 
     * @param listView
     *            帅新组件
     * @return
     */
    protected PullToRefreshListView initListView(PullToRefreshListView listView) {
        if (listView == null) {
            return null;
        }
        listView.setMode(Mode.BOTH);
        //以下为自定义提示语 可以不写使用默认的
        listView.getLoadingLayoutProxy(false, true).setPullLabel(getResources().getString(R.string.push_label));
        listView.getLoadingLayoutProxy(false, true).setRefreshingLabel(getResources().getString(R.string.refreshing_label));
        listView.getLoadingLayoutProxy(false, true).setReleaseLabel(getResources().getString(R.string.release_label));
        listView.getLoadingLayoutProxy(true, false).setPullLabel(getResources().getString(R.string.pull_label));
        listView.getLoadingLayoutProxy(true, false).setRefreshingLabel(getResources().getString(R.string.refreshing_label));
        listView.getLoadingLayoutProxy(true, false).setReleaseLabel(getResources().getString(R.string.release_label));

        listView.setOnRefreshListener(new OnRefreshListener2Impl());
        return listView;
    }

    /**
     * 获取成功的处理, 主要在handler 里面调用
     * 
     * @param msg
     */
    @SuppressWarnings({ "unchecked", "rawtypes" })
    protected void loadSucess(Message msg) {
        List ls = (List) msg.obj;
        if (getPageCount() == 1) {
            getList().clear();
            getListView().setMode(Mode.BOTH);
        }
        if (ls != null) {
            getList().addAll(ls);
        }
        getAdapter().notifyDataSetChanged();
        getListView().onRefreshComplete();
    };

    /**
     * 获取成功但是没有数据的处理, 主要在handler 里面调用
     * 
     * @param msg
     */
    protected void loadZeroDate(Message msg) {
        if (getPageCount() == 1) {
            Toast.makeText(this, R.string.zero_date, Toast.LENGTH_SHORT).show();

        } else {
            Toast.makeText(this, R.string.msg_last, Toast.LENGTH_SHORT).show();
        }
        getAdapter().notifyDataSetChanged();
        getListView().onRefreshComplete();
        getListView().setMode(Mode.PULL_FROM_START);
    };

    /**
     * 获取失败的处理, 主要在handler 里面调用
     * 
     * @param msg
     */
    protected void loadFalt(Message msg) {
        Toast.makeText(this, R.string.load_error, Toast.LENGTH_SHORT).show();
        getAdapter().notifyDataSetChanged();
        getListView().onRefreshComplete();
    };

    /**
     * 上拉刷新及加载更多的回调接口实现类
     * 
     * @author tom
     * 
     */
    private class OnRefreshListener2Impl implements OnRefreshListener2&lt;ListView&gt; {
        SimpleDateFormat sdf = new SimpleDateFormat(getResources().getString(R.string.refresh_for) + ":MM-dd hh:mm");

        @Override
        public void onPullDownToRefresh(PullToRefreshBase&lt;ListView&gt; refreshView) {
            //下拉
            status = 1;
            setPageCount(1);
            loadData();
            String label = sdf.format(System.currentTimeMillis());
            refreshView.getLoadingLayoutProxy().setLastUpdatedLabel(label);
        }

        @Override
        public void onPullUpToRefresh(PullToRefreshBase&lt;ListView&gt; refreshView) {
            //上拉
            status = -1;
            setPageCount(getPageCount() + 1);
            loadData();
            String label = sdf.format(System.currentTimeMillis());
            refreshView.getLoadingLayoutProxy().setLastUpdatedLabel(label);
        }
    }

}
</code></pre>

<p>如果你的界面里有一个以上的PullToRefreshListView组件,那你需要额外重写getPageCount和setPageCount来自己控制页码,当然这个时候其他几个重写的方法也需要你加上判断,具体示例我会在文章最后附上</p>

<p>下面看例子代码</p>

<pre><code class="python">package com.test;

import android.os.Message;


public class ChannelExhibitionListActivity extends ListViewBaseActivity {

    // 界面组件
    PullToRefreshListView _listView;
    List&lt;ChannelExhibitionListItem&gt; _list;
    ChannelExhibitionListAdapter _adapter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.channel_exhibition_list_activity);
        init();
    }

    private void init() {
        // 初始化组件及适配器
        _listView = initListView(R.id.listView);
        // 获取内部listview 推荐这样用而不是直接给_listview设置参数
        ListView actualListView = _listView.getRefreshableView();
        _adapter = new ChannelExhibitionListAdapter(this);
        _list = new ArrayList&lt;ChannelExhibitionListItem&gt;();
        _adapter.setList(_list);
        actualListView.setOnItemClickListener(new OnItemClickListener() {

            @Override
            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
                // 不要忘了这一行代码　　因为自带了headview 所以postiton加了1 这里要减去
                position--;
            }
        });
        actualListView.setAdapter(_adapter);

    }

    // 异步任务接受处理
    Handler _handler = new Handler() {
        public void handleMessage(android.os.Message msg) {
            switch (msg.what) {
            case LOAD_SUCCESS:
                loadSucess(msg);
                break;
            case LOAD_FAIL:
                loadFalt(msg);
                break;
            case LOAD_NODATA:
                loadZeroDate(msg);
                break;
            }
        }
    };

    // 获取数据的线程
    Thread loadThread;

    /**
     * 更改数据并刷新adapter
     */
    @Override
    public void loadData() {
        createCountryThread();
        loadThread.start();
    }

    /**
     * 初始化线程
     */
    private void createCountryThread() {
        loadThread = new Thread(new Runnable() {

            @Override
            public void run() {
                List&lt;ChannelExhibitionListItem&gt; channels = new ArrayList&lt;ChannelExhibitionListItem&gt;();
                try {
                    // 把页码拼接到url
                    StringBuffer loadService = new StringBuffer(); 
                    loadService.append("?r=findlist&amp;pagesize=15&amp;pagenow=" + getPageCount());

                    String res = HttpConstants.getPHPRequest("url", loadService.toString());
                    if (res == null || res.equals("")) {
                        throw new Exception("resoult=" + res);
                    }
                    JSONObject resultJsonObject = new JSONObject(res);
                    int code = resultJsonObject.getInt("returncode");
                    if (code == 0) {
                        // 业务处理　　大概就是解析出list
                        JSONArray datas = resultJsonObject.getJSONArray("result");
                        if (datas.length() == 0) {
                            Message m = _handler.obtainMessage(LOAD_NODATA);
                            _handler.sendMessage(m);
                            return;
                        }
                        int size = datas.length();
                        for (int i = 0; i &lt; size; i++) {
                            JSONObject obj = (JSONObject) datas.get(i);
                            ChannelExhibitionListItem item = new ChannelExhibitionListItem();
                            item.setId("");

                            channels.add(item);
                        }
                        Message message = _handler.obtainMessage(LOAD_SUCCESS);
                        message.obj = channels;
                        _handler.sendMessage(message);
                        return;
                    }else if(code == 1){
                        Message m = _handler.obtainMessage(LOAD_NODATA);
                        _handler.sendMessage(m);
                        return;
                    }
                    // 获取失败
                    Message m = _handler.obtainMessage(LOAD_FAIL);
                    _handler.sendMessage(m);
                } catch (Exception e) {
                    Message m = _handler.obtainMessage(LOAD_FAIL);
                    _handler.sendMessage(m);
                } finally {
                    //关闭进度条
                    //Util.dismissWaitingDialog(pd);
                }
            }
        });
    }

    @Override
    public List&lt;?&gt; getList() {
        return _list;
    }

    @Override
    public PullToRefreshListView getListView() {
        return _listView;
    }

    @Override
    public BaseAdapter getAdapter() {
        return _adapter;
    }
}
</code></pre>

<p>以上代码只是逻辑代码,复制在自己的项目中是不能运行的,参考着就可以写了,因为我们的项目是使用的httpClient+Handler回调,所以用这个特别方便, 如果你们项目使用Volley 那就更简单了,稍微修改一下就能用</p>

<p>最后是布局  布局只需要把ListView替换实现就可以 其他的一下属性和ListView通用</p>

<pre><code class="xml">  &lt;com.handmark.pulltorefresh.library.PullToRefreshListView
        android:id="@+id/listView"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:cacheColorHint="#00000000"
        android:divider="#19000000"
        android:dividerHeight="1dp"
        android:fadingEdge="none"
        android:fastScrollEnabled="false"
        android:footerDividersEnabled="true"
        android:headerDividersEnabled="true"
        android:smoothScrollbar="true" &gt;
    &lt;/com.handmark.pulltorefresh.library.PullToRefreshListView&gt;
</code></pre>

<h2>附</h2>

<p>多个PullToRefreshListView组件时的示例代码 , 其他几个重写的方法也要这样修改</p>

<pre><code class="java">/**
 *当前第几个PullToRefreshListView的标示
 */
int num=1;
/**
 * 页码
 */
private int count_p = 1;
private int count_r = 1;


/**
 * 获取页码
 * 
 * @return
 */
public int getPageCount() {
    if (num ==1) {
        return count_p;
    }else{
        return count_r;
    }
}

/**
 * 设置页码
 * 
 * @param pageCount
 */
public void setPageCount(int pageCount) {
    if (num ==1) {
        this.count_p = pageCount;
    }else{
        this.count_r = pageCount;
    }
}
</code></pre>

<p>写完啦 ,我要去腐败喽</p>

<hr />

</div>
    <div class="pure-g pagination">
        
        <a class="pure-u-1-2 pagination-item " href="/android/Android%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E5%9C%86%E5%BD%A2%E5%A4%B4%E5%83%8F(%E7%BB%AD).html" title="Android简单实现圆形头像(续) "><p> <i class="fa fa-mail-reply"></i>&nbsp;Android简单实现圆形头像(续)</p></a>
        
        
        <span class="pure-u-1-2 pagination-item "><p>下一篇&nbsp;<i class="fa fa-chain-broken"></i></p></span>
        
    </div>
    <link href="/css/code.css" rel="stylesheet">
    <link href="/css/min/fancybox.css" rel="stylesheet">
    <script src="/js/min/jquery.toc.min.js" ></script>
    <script src="/js/min/jquery.qrcode.min.js" ></script>
    <script src="/js/min/jquery.fancybox.pack.js" ></script>
    <!--<script src="/js/page.js" ></script>-->

    
    

    
    






            </div>
            </div>
           
        <div class="footer" style="float:left" >
                <a href="/about">About</a>
                <a href="http://kokerwang.lofter.com/">LOFTER</a>
                <a href="tencent://message/?uin=280995163">QQ</a>
                <a href="https://github.com/kokerwang">GitHub</a>
                <a href="http://www.kokerwang.com">Powered by KokerWang</a>
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253336121'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1253336121%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
            <script src="/js/min/nprogress.min.js"></script>
            <script src="/js/index.js"></script>
        </div>
        <div class="topfade"><a href="javascript:;" title="返回顶部"></a></div>
    </div>
</div>
</body>
</html>
